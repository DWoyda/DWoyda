name: Countdown Update

on:
  schedule:
    - cron: "0 * * * *" # run every hour
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-countdown:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set target date (next Sunday at 20:00 PL time)
        id: setup
        run: |
          # Calculate next Sunday 20:00 Polish time (19:00 UTC)
          TARGET_DATE=$(date -d "next sunday 19:00 UTC" -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "TARGET_DATE=$TARGET_DATE" >> $GITHUB_ENV

      - name: Calculate remaining time
        run: |
          NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          SECS_LEFT=$(( $(date -d "$TARGET_DATE" +%s) - $(date -d "$NOW" +%s) ))

          if [ $SECS_LEFT -lt 0 ]; then
            TEXT="Countdown finished ðŸŽ‰"
          else
            DAYS=$((SECS_LEFT / 86400))
            HOURS=$(( (SECS_LEFT % 86400) / 3600 ))
            TEXT="Time remaining: ${DAYS} days, ${HOURS} hours"
          fi

          # Update section in README.md
          sed -i "/<!-- TIMER_START -->/,/<!-- TIMER_END -->/c\<!-- TIMER_START -->\n${TEXT}\n<!-- TIMER_END -->" README.md

      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [[ `git status --porcelain` ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git
            git add README.md
            git commit -m "Update countdown"
            git push origin HEAD:${{ github.ref }}
          fi
